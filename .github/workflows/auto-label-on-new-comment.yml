name: Toggle "New comment" label on issues

on:
  issue_comment:
    types: [created]
  issues:
    types: [closed]

permissions:
  issues: write

jobs:
  toggle_label:
    runs-on: ubuntu-latest
    steps:
      - name: Toggle label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const LABEL = 'New comment';
            const MY_USER = 'qlerup';

            const { owner, repo } = context.repo;

            // --- If issue was closed: remove label (if present) ---
            if (context.eventName === 'issues' && context.payload.action === 'closed') {
              const issue_number = context.payload.issue.number;

              try {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: LABEL });
                core.info(`Issue closed -> removed label: ${LABEL}`);
              } catch (e) {
                // 404 happens if label isn't present
                if (e.status === 404) {
                  core.info(`Issue closed -> label not present: ${LABEL}`);
                } else {
                  throw e;
                }
              }
              return;
            }

            // --- Otherwise: issue_comment created ---
            // Skip PR comments
            if (context.payload.issue.pull_request) {
              core.info('Comment is on a PR. Skipping.');
              return;
            }

            const issue_number = context.payload.issue.number;
            const commenter = context.payload.comment.user?.login;
            const type = context.payload.comment.user?.type; // "User" | "Bot" | etc.

            // Ignore bots/apps/actions
            if (type !== 'User') {
              core.info(`Commenter type is "${type}". Skipping.`);
              return;
            }

            // Fetch current labels
            const { data: issue } = await github.rest.issues.get({ owner, repo, issue_number });
            const hasLabel = issue.labels.some(l => (typeof l === 'string' ? l : l.name) === LABEL);

            if (commenter === MY_USER) {
              // Your comment => remove label
              if (hasLabel) {
                await github.rest.issues.removeLabel({ owner, repo, issue_number, name: LABEL });
                core.info(`Removed label (you replied): ${LABEL}`);
              } else {
                core.info(`Label not present, nothing to remove: ${LABEL}`);
              }
              return;
            }

            // Other human comment => add label
            if (!hasLabel) {
              await github.rest.issues.addLabels({ owner, repo, issue_number, labels: [LABEL] });
              core.info(`Added label (new external comment): ${LABEL}`);
            } else {
              core.info(`Label already present: ${LABEL}`);
            }