name: Arm auto-close on label

on:
  issues:
    types: [labeled]

jobs:
  arm-autoclose:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    env:
      TRIGGER_LABEL: "Awaiting response"  # your label
      GRACE_DAYS: "2"
      BUFFER_MINUTES: "120"
      ALLOWED_STARTERS: "qlerup"          # who is allowed to arm by applying the label
    steps:
      - name: Add marker when trigger label is applied (by maintainer)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const applied = context.payload.label?.name || "";
            const sender = (context.payload.sender?.login || "").toLowerCase();

            // Only issues, not PRs
            if (issue.pull_request) return;

            // Check correct label (case-insensitive)
            if (applied.toLowerCase() !== (process.env.TRIGGER_LABEL || "").toLowerCase()) {
              core.info(`Label "${applied}" != TRIGGER_LABEL – skipping.`);
              return;
            }

            // Only allowed maintainers may arm
            const allowed = new Set((process.env.ALLOWED_STARTERS || "")
              .split(",").map(s => s.trim().toLowerCase()).filter(Boolean));
            const isAllowed = allowed.size === 0
              ? sender === owner.toLowerCase()
              : allowed.has(sender);
            if (!isAllowed) {
              core.info(`@${sender} is not in ALLOWED_STARTERS – ignoring.`);
              return;
            }

            const nowIso = new Date().toISOString();
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: issue.number,
              body: `Auto-close armed via label **${process.env.TRIGGER_LABEL}**. If there's no reply, this issue will be auto-closed in **${process.env.GRACE_DAYS} day(s)**.\n\n<!-- autoclose:start:${nowIso} -->`
            });

            core.info(`Armed auto-close for #${issue.number} at ${nowIso}.`);